{% liquid
    assign url = shop.url
    assign page_type = request.page_type
%}
{%- if page_type == 'product' -%}
    {%- liquid
        assign fa_current_variant = product.selected_or_first_available_variant
    -%}
    <script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "Product",
        "name": {{ product.title | json }},
        "url": "{{ shop.url }}{{ product.url }}",
        "image": [
            {%- for image in product.images limit: 10 -%}
              {{ image | img_url: '1024x1024' | prepend: 'https:' | json }}{% unless forloop.last %},{% endunless %}
            {%- endfor -%}
        ],
        "description": {{ product.description | strip_html | truncate: 5000 | json }},
        "sku": {{ fa_current_variant.sku | default: product.id | json }},
        "mpn": {{ fa_current_variant.sku | default: product.id | json }},
        "brand": {
            "@type": "Brand",
            "name": {{ product.vendor | json }}
        },
        {%- if product.metafields.reviews.rating.value != blank or product.metafields.judgeme.badge != blank -%}
          {%- if product.metafields.reviews.rating.value != blank -%}
            "aggregateRating": {
              "@type": "AggregateRating",
              "ratingValue": {{ product.metafields.reviews.rating.value }},
              "reviewCount": {{ product.metafields.reviews.rating_count }},
              "bestRating": "5",
              "worstRating": "1"
            },
          {%- elsif product.metafields.judgeme.badge != blank -%}
            {%- assign rating_value = product.metafields.judgeme.badge | split: "data-average-rating='" | last | split: "'" | first | plus: 0 -%}
            {%- assign review_count = product.metafields.judgeme.badge | split: "data-number-of-reviews='" | last | split: "'" | first | plus: 0 -%}
            {%- if rating_value > 0 -%}
              "aggregateRating": {
                "@type": "AggregateRating",
                "ratingValue": {{ rating_value }},
                "reviewCount": {{ review_count }},
                "bestRating": "5",
                "worstRating": "1"
              },
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}
        "offers": [
          {%- for variant in product.variants -%}
            {
              "@type": "Offer",
              "name": {{ product.title | append: ' - ' | append: variant.title | json }},
              "priceCurrency": {{ cart.currency.iso_code | json }},
              "price": {{ variant.price | divided_by: 100.0 | json }},
              "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}",
              "itemCondition": "https://schema.org/NewCondition",
              "availability": "https://schema.org/{% if variant.available %}InStock{% else %}OutOfStock{% endif %}",
              "url": {{ shop.url | append: variant.url | json }},
              "sku": {{ variant.sku | default: variant.id | json }},
              "seller": {
                "@type": "Organization",
                "name": {{ shop.name | json }}
              }
            }{% unless forloop.last %},{% endunless %}
          {%- endfor -%}
        ]
    }
    </script>
{%- elsif page_type == 'article' -%}
    <script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "Article",
        "name": {{ article.title | json }},
        "description": {{ article.content | strip_html | truncate: 160 | json }},
        "author": {{ article.author | json }},
        "image": {{ article.image | img_url: '1024x1024' | prepend: 'https:' | json }},
        "headline": {{ article.title | json }},
        "datePublished": "{{ article.created_at | date: '%Y-%m-%d' }}",
        "dateModified": "{{ article.published_at | date: '%Y-%m-%d' }}"
    }
    </script>
{%- elsif page_type == 'collection' and collection.handle -%}
    <script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "CollectionPage",
        "name": {{ collection.title | json }},
        "url": "{{ shop.url }}{{ collection.url }}",
        "description": {{ collection.description | strip_html | truncate: 160 | json }}
    }
    </script>
{%- endif -%}
